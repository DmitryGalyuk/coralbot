<html>
<head>
    <title>MermaidJS Diagram</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="js/parser.js" type="module"></script>
    <script src="js/member.js" type="module"></script>
    <script src="js/render.js" type="module"></script>

    <script type="module">
        import ReportParses from './js/parser.js'
        import Renderer from './js/render.js' 
        import Member from './js/member.js'

        async function parseUploaded(){
            const file = document.querySelector('#excelFile').files[0];
            let parser = new ReportParses(file);
            let data = Member.flattenTree(await parser.parseExcel());
            let summary = parser.summary;
            
            document.getElementById("output").innerText = summary;

            let renderer = new Renderer(data);
            let mermaidStr = renderer.renderMermaid();
            // console.log(mermaidStr);

            // Initializing mermaid
            mermaid.initialize({
                startOnLoad: true,
                htmlLabels: true,
                // securityLevel: "loose",
                maxTextSize: 9000000,
                flowchart:{
                    useMaxWidth: 0,
                    padding: 10,
                    htmlLabels: true,
                    // defaultRenderer: 'dagre-d3'
                } 
            });

            var element = document.getElementById("diagram");
            var insertSvg = function (svgCode, bindFunctions) {
                element.innerHTML = svgCode.svg;
                bindFunctions?.(element);
        };

        var graph = mermaid.render('some', mermaidStr).then(insertSvg);
        // var graph = mermaid.render('some', mermaidStr, insertSvg);
        }

        document.getElementById("btnParse").addEventListener('click', parseUploaded);
    </script>
</head>

<body>
     Выбрать файл отчёта <input type="file" id="excelFile" />

    <button id="btnParse">Загрузить</button>
    <pre id="output"></pre>

    <div id="diagram"></div>

</body>

</html>