<html>

<head>
    <title>Coralometer</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/diagram.css">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="mask-icon" href="/apple-touch-icon.png">
    <link rel="manifest" href="/site.webmanifest">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="js/parser.js" type="module"></script>
    <script src="js/member.js" type="module"></script>
    <script src="js/render.js" type="module"></script>

    <script type="module">
        import ReportParses from './js/parser.js'
        import Renderer from './js/render.js'
        import Member from './js/member.js'

        let root = undefined;

        async function parseUploaded() {
            const file = document.querySelector('#excelFile').files[0];
            let parser = new ReportParses(file, "ru");
            root = await parser.parseExcel();

            renderData(root);
        }

        function renderData(node) {
            let data = Member.flattenTree(node);

            let renderer = new Renderer(data);

            let diagElement = document.getElementById("diagram");
            let mermaidStr = renderer.renderMermaid(diagElement);

            renderer.renderBreadcrumbs(document.getElementById("breadcrumbs"), node);

        };

        document.getElementById("btnParse").addEventListener('click', parseUploaded);

        // Add a click event listener to the document
        document.addEventListener('click', function (event) {
            // Check if the clicked element is a link with a hash
            if (event.target.tagName === 'A' && event.target.hash) {
                event.preventDefault(); // Prevent the default action
                let hash = parseInt(event.target.hash.substring(1)); // Get the hash and remove the '#'
                let node = root.findChild(hash);
                renderData(node);
            }
        });
    </script>
</head>

<body>
    Выбрать файл отчёта <input type="file" id="excelFile" />

    <button id="btnParse">Загрузить</button>
    <pre id="output"></pre>

    <div id="breadcrumbs"></div>
    <br>

    <div id="diagram"></div>

</body>

</html>