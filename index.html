<html>

<head>
    <title>Coralometer</title>
    <meta charset="UTF-8">


    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img//favicon-16x16.png">
    <link rel="mask-icon" href="./img//apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">

    <!-- <link rel="reference" href="https://mtennekes.github.io/downloads/publications/TreeColors_manuscript.pdf"> -->

    <script src="https://kit.fontawesome.com/b0394b38ac.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <link rel="stylesheet" href="css/diagram.css">

    <script type="module">
        import ReportParses from './js/parser.js'
        import Renderer from './js/render.js'
        import Member from './js/member.js'

        let root = undefined;

        async function parseUploaded() {
            location.hash = "";
            const file = document.querySelector('#excelFile').files[0];
            let parser = new ReportParses(file, "ru");
            root = await parser.parseExcel();

            renderData(root);
        }

        function renderData(node) {
            let renderer = new Renderer();

            // renderer.renderNoOrders(document.getElementById("noOrders"), Member.query(root,
            //     n => n.monthNoVolume == 3, p=>p.isDirector()));

            renderer.renderMermaidFlow(document.getElementById("diagram"), node);

            renderer.renderBreadcrumbs(document.getElementById("breadcrumbs"), node);

            renderer.renderMermaidMindmap(document.getElementById("mm"), node);

        };

        document.getElementById("excelFile").addEventListener('change', parseUploaded);

        // Add a click event listener to the document
        document.addEventListener('click', function (event) {
            if( event.target.tagName === "tspan") {
                let mindmapdiv = document.getElementById("mm");
                if (!mindmapdiv.contains(event.srcElement) ){
                    return;
                }
                let elem = event.srcElement;
                while (elem && mindmapdiv.contains(elem)) {
                    if (elem.classList.contains("mindmap-node")) {
                        let id;
                        for (let c of elem.classList) {
                            if( c.startsWith("n")) {
                                id = c.substring(1);
                                break;
                            }
                        }
                        event.preventDefault();
                        location.hash = "#"+id;
                        renderData(root.findChild(id));
                        return;
                    }
                    elem = elem.parentElement;
                }
            }

            // Check if the clicked element is a link with a hash
            if (event.target.tagName === 'A' && event.target.hash) {
                event.preventDefault(); // Prevent the default action
                let hash = parseInt(event.target.hash.substring(1)); // Get the hash and remove the '#'
                let node = root.findChild(hash);
                renderData(node);
            }
        });

        document.getElementById("btnDirectorsOnly").addEventListener("click", toggleDirectorsOnly);
        document.getElementById("btnNoOrders").addEventListener("click", toggleNoOrders);

        function toggleNoOrders() {
            renderData(Member.query(root,
                n => 1 < n.monthNoVolume && n.monthNoVolume < 4,
                p => p.isDirector()) );
        }

        function toggleDirectorsOnly() {
            renderData( Member.query(root, n=>n.isDirector(), p=>p.isDirector()) );
        }
    </script>
</head>

<body>
    Выбрать файл отчёта <input type="file" id="excelFile" /> <br>
    
    <button id="btnDirectorsOnly">Только директора</button>
    <button id="btnNoOrders">Без закупок до 3 мес</button>
    <!-- <button id="btnHideZeros">Спрятать нули</button> -->

    <br>

    <div id="noOrders"></div>

    <div id="breadcrumbs"></div>
    <br>

    <div id="mm"></div>
    <div id="diagram"></div>



</body>

</html>