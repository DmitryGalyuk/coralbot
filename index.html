<html>

<head>
    <title>MermaidJS Diagram</title>
    <meta charset="UTF-8">
    <!-- <script src="./data.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="js/parser.js" type="module"></script>
    <script type="module">
        import parseReport from './js/parser.js'
        async function parseUploaded(){
            const file = document.querySelector('#excelFile').files[0];
            let [summary, data] = await parseReport(file);
            
            document.getElementById("output").innerText = summary;

            let mermaidStr = jsonToMermaid(data);
            // console.log(mermaidStr);

            // Initializing mermaid
            mermaid.initialize({
                startOnLoad: true,
            });

            var element = document.getElementById("diagram");
            var insertSvg = function (svgCode, bindFunctions) {
                element.innerHTML = svgCode.svg;
                bindFunctions?.(element);
        };

        var graph = mermaid.render('some', mermaidStr).then(insertSvg);
        // var graph = mermaid.render('some', mermaidStr, insertSvg);
        }

        function jsonToMermaid(data) {
            let mermaidStr = 'graph LR;\n';
            data.forEach(item => {
                const parent = item.parent;
                const id = item.id;
                const name = item.name;

                if (parent && id) {
                    mermaidStr += `${parent} --> ${id}[<span id='${id}'></span>${name}]\n`;
                }
                else {
                    mermaidStr += `${id}[${name}]\n`
                }
            });
            return mermaidStr;
        }

        document.getElementById("btnParse").addEventListener('click', parseUploaded);
    </script>
</head>

<body>
    <a href="#7347941">Мнацаканова Софья</a>
    
    flowchart LR
    A:::someclass --> B
    classDef someclass fill:#f96
    <input type="file" id="excelFile" />

    <button id="btnParse">Parse File</button>

    <pre id="output"></pre>

    <div id="diagram"></div>

</body>

</html>