<html>

<head>
    <title>Coralometer</title>
    <meta charset="UTF-8">


    <link rel="apple-touch-icon" sizes="180x180" href="./img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./img//favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./img//favicon-16x16.png">
    <link rel="mask-icon" href="./img//apple-touch-icon.png">
    <link rel="manifest" href="site.webmanifest">

    <!-- <link rel="reference" href="https://mtennekes.github.io/downloads/publications/TreeColors_manuscript.pdf"> -->

    <script src="https://kit.fontawesome.com/b0394b38ac.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>

    <link rel="stylesheet" href="css/diagram.css">

    <script type="module">
        import ReportParses from './js/parser.js'
        import Renderer from './js/render.js'
        import Member from './js/member.js'
        import {Settings} from './js/utils.js'
        import { getTranslator } from "./js/translator.js";


        let root = undefined;
        let renderer = new Renderer("diagram", "mm", "breadcrumbs");
        
        const T = await getTranslator();
        let selectLang = document.getElementById("selectLang");
        if (Settings.language) {
            await T.use(Settings.language);
        } else {
            Settings.language = T.currentLanguage;
        }
        T.languages.forEach(l => {
            selectLang.add(new Option(l.name, l.code, l.code==T.currentLanguage, l.code==T.currentLanguage));
        });
        translate();
        selectLang.addEventListener("change", async (e)=>{
            Settings.language=e.target.value;
            await T.use(e.target.value);
            translate();
        });

        function translate() {
            document.getElementById("spanSelectFile").textContent = T.SelectFile;
            document.getElementById("btnDirectorsOnly").textContent = T.directorsOnly;
            // document.getElementById("btnMastersOnly").textContent = T.mastersOnly;
            document.getElementById("btnNoOrders").textContent = T.noOrdersXMonths(3);
            document.getElementById("btnNoFilter").textContent = T.showFullStructure;
        }

        document.getElementById("excelFile").addEventListener('change', parseUploaded);

        document.getElementById("btnDirectorsOnly").addEventListener("click", ()=>
            renderer.renderData( Member.query(root, n=>n.isDirector(), p=>p.isDirector())));
        // document.getElementById("btnMastersOnly").addEventListener("click", ()=>
        //     renderer.renderData( Member.query(root, n=>n.isMaster(), p=>p.isMaster())));
        document.getElementById("btnNoOrders").addEventListener("click", ()=>
            renderer.renderData(Member.query(root, n => 1 < n.monthNoVolume && n.monthNoVolume < 4, p => p.isDirector())));
        document.getElementById("btnNoFilter").addEventListener("click", ()=>
            renderer.renderData(root));

        async function parseUploaded() {
            location.hash = "";
            document.getElementById("spanParseFailed").textContent = "";
            
            let lang = Settings.language;
            const file = document.querySelector('#excelFile').files[0];
            let parser;
            try {
                parser = new ReportParses(file, lang);
                root = await parser.parseExcel();
            }
            catch {
                document.querySelector('#excelFile').value = null;
                document.getElementById("spanParseFailed").textContent = T.parseFailedMessage("dmitry@galyuk.com");
                return;
            }
            renderer.dataRoot = root;

            renderer.renderData(root);
        }

    </script>
</head>

<body>
    <i class="fa-solid fa-language"></i>
    <select id="selectLang"></select> 
    <span id="spanSelectFile"></span> <input type="file" id="excelFile" /> <span id="spanParseFailed" class="errorMessage"></span> <br>
    
    <button id="btnDirectorsOnly">Только Директора</button>
    <!-- <button id="btnMastersOnly">Только Мастера</button> -->
    <button id="btnNoOrders">Без закупок до 3 мес</button>
    <button id="btnNoFilter">Показать всю структуру</button>

    <!-- <button id="btnHideZeros">Спрятать нули</button> -->

    <br>

    <div id="noOrders"></div>

    <div id="breadcrumbs"></div>
    <br>

    <div id="mm"></div>
    <div id="diagram"></div>



</body>

</html>